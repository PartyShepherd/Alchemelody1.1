<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alchemelody</title>
<link rel="manifest" href="manifest.json">
<style>
  body { font-family: Arial, sans-serif; text-align: center; background-color: black; color: white; }
  .header { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
  .header h1 { margin: 0; font-size: 2rem; }
  .header img { width: 50px; margin-left: 10px; }
  .subheading { font-style: italic; margin: 5px 0 10px 0; }
  form { margin-top: 10px; display: inline-block; }
  input { padding: 5px; font-size: 0.9rem; width: 100px; margin: 5px; }
  .input-label { display: inline-block; margin: 5px; }
  button { padding: 5px 10px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: black; }
  button.Sun { background-color: orange; }
  button.Mars { background-color: red; }
  button.Venus { background-color: green; }
  button.Jupiter { background-color: purple; }
  button.Moon { background-color: blue; }
  button.Mercury { background-color: yellow; }
  button.Saturn { background-color: indigo; }
  .hour-entry { margin: 10px; padding: 10px; text-align: center; }
  .planet-time { color: white; }
  #flash { position: fixed; top:0; left:0; width:100%; height:100%; z-index:1000; display:none; }
</style>
</head>
<body>
<div class="header">
  <h1>Alchemelody</h1>
  <img src="{{ url_for('static', filename='images/header.jpg') }}" alt="Header Image">
</div>
<p class="subheading">Official App of the band: The Source of All</p>

<form method="POST">
  <label class="input-label" for="latitude">Latitude:</label>
  <input type="text" name="latitude" id="latitude" placeholder="Enter Latitude" value="{{ location.latitude }}" required>
  <label class="input-label" for="longitude">Longitude:</label>
  <input type="text" name="longitude" id="longitude" placeholder="Enter Longitude" value="{{ location.longitude }}" required>
  <button type="submit">Set Location</button>
</form>

<button id="consentButton">Enable Background Alarms ðŸ””</button>

<div id="flash"></div>
<ul>
{% for time, planet in hours %}
<li class="hour-entry">
  <span class="planet-time {{ planet }}">{{ time }}</span>
  <button class="{{ planet }}" onclick="playSound('{{ planet }}', '{{ colors[planet] }}')">Play {{ planet }}</button>
</li>
{% endfor %}
</ul>

<script>
  const planetColors = {
    "Sun": "ðŸŸ§",
    "Mars": "ðŸŸ¥",
    "Venus": "ðŸŸ©",
    "Jupiter": "ðŸŸª",
    "Moon": "ðŸŸ¦",
    "Mercury": "ðŸŸ¨",
    "Saturn": "ðŸŸ¦"
  };

  function flashColor(color) {
    const flashDiv = document.getElementById("flash");
    flashDiv.style.backgroundColor = color;
    flashDiv.style.display = "block";
    setTimeout(() => { flashDiv.style.display = "none"; }, 500);
  }

  function playSound(planet, color) {
    flashColor(color);
    const audio = new Audio(`/static/sounds/${planet}.wav`);
    audio.play().catch(console.error);
    fetch("/play", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({planet})
    }).then(r=>r.json()).then(d=>console.log(d.message)).catch(console.error);
  }

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(() => console.log('SW registered'));
  }

  document.getElementById("consentButton").addEventListener("click", async () => {
    if (!("Notification" in window)) return alert("Notifications not supported!");
    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      alert("Background alarms enabled!");
      startBackgroundCheck();
      document.getElementById("consentButton").style.display = "none";
    }
  });

  function startBackgroundCheck() {
    if (!navigator.serviceWorker.controller) return;
    setInterval(() => {
      const now = new Date();
      {% for time, planet in hours %}
      const alarmTime = new Date("{{ time }}");
      if (Math.abs(now.getHours()*60 + now.getMinutes() - {{ loop.index0 }}*60) < 1) {
        navigator.serviceWorker.controller.postMessage({planet:"{{ planet }}"});
      }
      {% endfor %}
    }, 60000);
  }
</script>
</body>
</html>
