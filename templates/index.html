<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Planetary Hour Alarm</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Fontdiner+Swanky&display=swap" rel="stylesheet">

<style>
body {
    background-color: black;
    color: white;
    text-align: center;
    font-family: Arial, sans-serif;
}
button {
    padding: 8px 14px;
    margin: 5px;
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
}
button.Sun { background: orange; }
button.Mars { background: red; }
button.Venus { background: green; }
button.Jupiter { background: purple; }
button.Moon { background: blue; }
button.Mercury { background: yellow; color:black; }
button.Saturn { background: indigo; }
.hour-entry { margin: 10px 0; }
#flash {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 999;
}
</style>
</head>
<body>

<!-- HEADER NAV -->
<div style="margin-bottom:20px;">
    <a href="{{ url_for('planner') }}"><button>Planner</button></a>
    <a href="{{ url_for('sigils') }}"><button>Sigils</button></a>
    <a href="{{ url_for('alarm') }}"><button>Planetary Alarm</button></a>
</div>
<hr>

<h1 style="font-family:'Fontdiner Swanky';">Alchemelody</h1>

<form method="POST">
    Latitude:
    <input type="text" name="latitude" value="{{ location.latitude }}" required>
    Longitude:
    <input type="text" name="longitude" value="{{ location.longitude }}" required>
    <button type="submit">Set Location</button>
</form>

<button onclick="enableAlarms()">Enable Alarm Sounds</button>

<div id="flash"></div>

<ul style="list-style:none; padding:0;">
{% for entry in hours %}
<li class="hour-entry">
    {{ entry.time_str }}
    <button class="{{ entry.planet }}"
        onclick="playSound('{{ entry.planet }}','{{ colors[entry.planet] }}')">
        {{ entry.planet }}
    </button>
</li>
{% endfor %}
</ul>

<script>
let alarmsEnabled = false;
let triggered = new Set();

const planetaryHours = [
{% for entry in hours %}
{hour: {{ entry.hour }}, minute: {{ entry.minute }}, planet: "{{ entry.planet }}", color: "{{ colors[entry.planet] }}"},
{% endfor %}
];

function enableAlarms() {
    alarmsEnabled = true;
}

function flash(color) {
    const f = document.getElementById("flash");
    f.style.backgroundColor = color;
    f.style.display = "block";
    setTimeout(()=>f.style.display="none",400);
}

function playSound(planet, color) {
    flash(color);
    const audio = new Audio(`/static/sounds/${planet}.wav`);
    audio.play();
    fetch("/play",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planet})});
}

setInterval(()=>{
    if(!alarmsEnabled) return;
    const now = new Date();
    planetaryHours.forEach(h=>{
        const key = `${h.hour}:${h.minute}`;
        if(now.getHours()==h.hour && now.getMinutes()==h.minute && !triggered.has(key)){
            playSound(h.planet,h.color);
            triggered.add(key);
        }
        if(now.getMinutes()!=h.minute) triggered.delete(key);
    });
},60000);
</script>

</body>
</html>
